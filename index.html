<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionale ASD Freestylife</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4a90e2; --primary-hover: #357abd; --secondary-color: #50e3c2;
            --background-color: #f7f9fc; --card-background: #ffffff; --text-color: #4a4a4a;
            --light-gray: #e6e6e6; --red-alert: #d0021b;
        }
        body { font-family: 'Poppins', sans-serif; margin: 0; padding: 20px; background-color: var(--background-color); color: var(--text-color); }
        .container { max-width: 1200px; margin: auto; background: var(--card-background); padding: 2em; border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08); }
        h1, h2, h3, h4 { color: var(--primary-color); }
        h1 { text-align: center; margin-bottom: 1.5em; }
        h2 { border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; }
        .hidden { display: none !important; }
        button, .button { background: linear-gradient(145deg, var(--primary-color), #3a7ac8); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; margin: 5px; font-weight: 500; font-family: 'Poppins', sans-serif; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.15); background: linear-gradient(145deg, var(--primary-hover), #2a6ac0); }
        .secondary-button { background: #6c757d; }
        .secondary-button:hover { background: #5a6268; }
        .download-button { background: #28a745; }
        .download-button:hover { background: #218838; }
        .location-selector button { display: block; width: 100%; margin-bottom: 15px; font-size: 1.2em; }
        #password-prompt { margin-top: 20px; padding: 20px; border: 1px solid var(--light-gray); border-radius: 8px; background: #fdfdfd; }
        #password-error { color: var(--red-alert); margin-top: 10px; font-weight: 500; }
        .main-menu { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
        .page { margin-top: 30px; border-top: 1px solid var(--light-gray); padding-top: 20px; }
        .page-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
        input, select { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid var(--light-gray); border-radius: 8px; box-sizing: border-box; font-family: 'Poppins', sans-serif; font-size: 1em; }
        input:focus, select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.3); }
        .form-section { background: #fdfdfd; padding: 20px; border-radius: 8px; border: 1px solid var(--light-gray); margin-top: 20px; }
        .list-container { margin-top: 20px; }
        .list-item-card { background: var(--card-background); border-radius: 8px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); overflow: hidden; border: 1px solid var(--light-gray); }
        .collapsible { background-color: var(--card-background); color: var(--text-color); cursor: pointer; padding: 18px 20px; width: 100%; border: none; text-align: left; outline: none; font-size: 1.1em; font-weight: 600; transition: background-color 0.3s ease; }
        .active, .collapsible:hover { background-color: #f1f5f8; }
        .collapsible::after { content: '\\2795'; font-size: 0.8em; color: var(--primary-color); float: right; margin-left: 5px; transition: transform 0.3s ease; }
        .active::after { transform: rotate(45deg); }
        .content { padding: 0 20px; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out, padding 0.3s ease-out; background-color: white; }
        .content-inner { padding: 15px 0; border-top: 1px solid var(--light-gray); }
        .renewal-alert { background-color: #fff2f2; border-left: 6px solid var(--red-alert); margin: 15px 0; padding: 10px 15px; border-radius: 4px; }
        .renewal-alert button { background: var(--red-alert); }
    </style>
</head>
<body>

    <div class="container">
        <h1>ASD Freestylife</h1>
        <div id="location-selection">
            <h2>Seleziona una sede</h2>
            <div class="location-selector">
                <button onclick="promptPassword('Milano', 'Cotoletta')">Milano</button>
                <button onclick="promptPassword('Bologna', 'Tortellino')">Bologna</button>
                <button onclick="promptPassword('Verona', 'Bigolo')">Verona</button>
            </div>
             <div id="password-prompt" class="hidden">
                <h3 id="password-title"></h3>
                <input type="password" id="password-input" placeholder="Inserisci la password">
                <button id="password-submit">Accedi</button>
                <button class="secondary-button" onclick="goBackToLocationSelection(true)">Annulla</button>
                <p id="password-error" class="hidden">Password errata. Riprova.</p>
            </div>
        </div>
        <div id="main-app" class="hidden">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2 id="location-title"></h2>
                <button class="secondary-button" onclick="goBackToLocationSelection()">Cambia Sede</button>
            </div>
            <div class="main-menu">
                <button onclick="showPage('corsi')">Corsi Attivi</button>
                <button onclick="showPage('tesserati')">Archivio Tesserati</button>
                <button onclick="showPage('pagamenti')">Pagamenti</button>
                <button onclick="showPage('lezioni-private')">Lezioni Private</button>
                <button onclick="showPage('lezioni-prova')">Lezioni di Prova</button>
            </div>

            <!-- PAGINA CORSI -->
            <div id="page-corsi" class="page hidden">
                <h3>Gestione Corsi</h3>
                 <div class="page-header">
                    <input type="text" id="search-corsi" onkeyup="searchList('search-corsi', 'corsi-list')" placeholder="Cerca corso..." style="flex-grow: 1;">
                    <div>
                        <button onclick="toggleForm('form-nuovo-corso')">Nuovo Corso</button>
                        <button class="download-button" onclick="downloadExcel('corsi-list', 'Corsi')">Scarica Excel</button>
                    </div>
                </div>
                <div id="form-nuovo-corso" class="form-section hidden">
                    <h4>Nuovo Corso</h4>
                    <input type="text" id="nome-corso" placeholder="Nome del corso">
                    <input type="text" id="istruttori-corso" placeholder="Istruttori di riferimento">
                    <input type="text" id="giorni-corso" placeholder="Giornate e orari del corso (es. Lun-Mer 18:00-19:00)">
                    <button onclick="aggiungiCorso()">Aggiungi Corso</button>
                </div>
                <div id="corsi-list" class="list-container"></div>
            </div>

            <!-- PAGINA TESSERATI -->
            <div id="page-tesserati" class="page hidden">
                <h3>Archivio Tesserati</h3>
                 <div class="page-header">
                    <input type="text" id="search-tesserati" onkeyup="searchList('search-tesserati', 'tesserati-list')" placeholder="Cerca tesserato..." style="flex-grow: 1;">
                    <div>
                        <button onclick="toggleForm('form-nuovo-tesserato')">Nuovo Tesserato</button>
                        <button class="download-button" onclick="downloadExcel('tesserati-list', 'Tesserati')">Scarica Excel</button>
                    </div>
                </div>
                <div id="form-nuovo-tesserato" class="form-section hidden">
                    <h4>Nuovo Tesserato</h4>
                    <input type="text" id="nome-tesserato" placeholder="Nome*"><input type="text" id="cognome-tesserato" placeholder="Cognome*"><input type="text" id="genitore-tesserato" placeholder="Nome e cognome genitore (se minorenne)"><label for="nascita-tesserato">Data di nascita*</label><input type="date" id="nascita-tesserato"><input type="text" id="luogo-nascita-tesserato" placeholder="Luogo di nascita*"><input type="text" id="cf-tesserato" placeholder="Codice Fiscale"><input type="email" id="email-tesserato" placeholder="Mail"><input type="tel" id="telefono-tesserato" placeholder="Telefono"><label for="scadenza-certificato">Scadenza certificato medico</label><input type="date" id="scadenza-certificato"><button onclick="aggiungiTesserato()">Aggiungi Tesserato</button>
                </div>
                <div id="tesserati-list" class="list-container"></div>
            </div>

            <!-- PAGINA PAGAMENTI -->
            <div id="page-pagamenti" class="page hidden">
                <h3>Registra Pagamento</h3>
                 <div class="page-header">
                    <input type="text" id="search-pagamenti" onkeyup="searchList('search-pagamenti', 'pagamenti-list')" placeholder="Cerca pagamento per nominativo..." style="flex-grow: 1;">
                    <div>
                        <button onclick="toggleForm('form-nuovo-pagamento')">Nuovo Pagamento</button>
                        <button class="download-button" onclick="downloadExcel('pagamenti-list', 'Pagamenti')">Scarica Excel</button>
                    </div>
                </div>
                <div id="form-nuovo-pagamento" class="form-section hidden">
                    <h4>Nuovo Pagamento</h4>
                    <select id="tesserato-pagamento"></select><input type="number" id="importo-pagamento" placeholder="Importo pagato (€)">
                    <select id="metodo-pagamento"><option value="contanti">Contanti</option><option value="bancomat">Bancomat</option><option value="bonifico">Bonifico</option><option value="satispay">Satispay</option></select>
                    <select id="corso-pagamento"></select><label for="scadenza-abbonamento">Data scadenza abbonamento</label><input type="date" id="scadenza-abbonamento"><button onclick="aggiungiPagamento()">Aggiungi Pagamento</button>
                </div>
                <div id="pagamenti-list" class="list-container"></div>
            </div>

            <!-- PAGINA LEZIONI PRIVATE -->
            <div id="page-lezioni-private" class="page hidden">
                <h3>Gestione Lezioni Private</h3>
                 <div class="page-header">
                    <input type="text" id="search-lezioni-private" onkeyup="searchList('search-lezioni-private', 'lezioni-private-list')" placeholder="Cerca per nominativo..." style="flex-grow: 1;">
                    <select id="filtro-istruttore-privata" onchange="renderLezioniPrivate()" style="flex-grow: 1; max-width: 250px;"></select>
                    <div>
                        <button onclick="toggleForm('form-lezione-privata')">Vendi Prodotto</button>
                        <button class="download-button" onclick="downloadExcel('lezioni-private-list', 'Lezioni_Private')">Scarica Excel</button>
                    </div>
                </div>
                <div id="form-lezione-privata" class="form-section hidden">
                    <h4>Nuova Vendita</h4>
                    <select id="tesserato-lezione-privata"></select><input type="text" id="istruttore-lezione-privata" placeholder="Nome Istruttore*">
                    <select id="prodotto-lezione-privata" onchange="togglePacchettoDate(this.value)"><option value="singola">Lezione Individuale Singola</option><option value="pacchetto">Pacchetto 10 Lezioni</option></select>
                    <input type="number" id="costo-lezione-privata" placeholder="Costo (€)">
                    <select id="metodo-pagamento-privata"><option value="contanti">Contanti</option><option value="bancomat">Bancomat</option><option value="bonifico">Bonifico</option><option value="satispay">Satispay</option></select>
                    <div id="data-lezione-singola-container"><label for="data-lezione-singola">Data Lezione</label><input type="date" id="data-lezione-singola"></div>
                    <div id="date-pacchetto" class="hidden"><h4>Inserisci date pacchetto (fino a 10)</h4><div id="date-inputs"><input type="date" class="data-pacchetto-input"></div><button type="button" class="secondary-button" onclick="addDateInput()">Aggiungi Data</button></div>
                    <button onclick="aggiungiVenditaPrivata()">Aggiungi Vendita</button>
                </div>
                <div id="lezioni-private-list" class="list-container"></div>
            </div>

            <!-- PAGINA LEZIONI DI PROVA -->
            <div id="page-lezioni-prova" class="page hidden">
                <h3>Registro Lezioni di Prova</h3>
                 <div class="page-header">
                    <input type="text" id="search-lezioni-prova" onkeyup="searchList('search-lezioni-prova', 'lezioni-prova-list')" placeholder="Cerca per nominativo..." style="flex-grow: 1;">
                    <select id="filtro-corso-prova" onchange="renderLezioniProva()" style="flex-grow: 1; max-width: 250px;"></select>
                    <div>
                        <button onclick="toggleForm('form-lezione-prova')">Registra Prova</button>
                        <button class="download-button" onclick="downloadExcel('lezioni-prova-list', 'Lezioni_Prova')">Scarica Excel</button>
                    </div>
                </div>
                <div id="form-lezione-prova" class="form-section hidden">
                    <h4>Nuova Lezione di Prova</h4>
                    <input type="text" id="nome-prova" placeholder="Nome"><input type="text" id="cognome-prova" placeholder="Cognome"><input type="text" id="genitore-prova" placeholder="Nome e cognome genitore (se minorenne)"><label for="corso-provato">Corso Provato</label><select id="corso-provato"></select><label for="data-prova">Data della Prova</label><input type="date" id="data-prova"><input type="email" id="email-prova" placeholder="Mail"><input type="tel" id="telefono-prova" placeholder="Telefono"><button onclick="aggiungiLezioneProva()">Aggiungi Prova</button>
                </div>
                <div id="lezioni-prova-list" class="list-container"></div>
            </div>
        </div>
    </div>

    <!-- SCRIPT DI FIREBASE (da includere prima del tuo script principale) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <!-- Libreria per esportare in Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

    <script>
        // =======================================================================
        // =======================================================================
        //
        //       CONFIGURAZIONE FIREBASE INSERITA
        //
        // =======================================================================
        // =======================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyCWLghMfbgkSng3hhHj44KLlQ0C6KzEyU8",
            authDomain: "gestionale-asd.firebaseapp.com",
            projectId: "gestionale-asd",
            storageBucket: "gestionale-asd.appspot.com",
            messagingSenderId: "111470303707",
            appId: "1:111470303707:web:676f2d47a024ce9c732ffe",
            measurementId: "G-FSNGYNGMKR"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let currentSede = '';
        let localDataCache = {}; 

        function formatDate(dateString) { if (!dateString) return 'N/D'; const date = new Date(dateString); if (isNaN(date.getTime())) return 'N/D'; const day = String(date.getDate()).padStart(2, '0'); const month = String(date.getMonth() + 1).padStart(2, '0'); const year = date.getFullYear(); return `${day}/${month}/${year}`; }

        function promptPassword(sede, correctPassword) {
            currentSede = sede.toLowerCase();
            document.querySelector('.location-selector').classList.add('hidden');
            const promptDiv = document.getElementById('password-prompt');
            promptDiv.classList.remove('hidden');
            document.getElementById('password-title').innerText = `Accesso per la sede di ${sede}`;
            document.getElementById('password-input').value = '';
            document.getElementById('password-error').classList.add('hidden');
            document.getElementById('password-input').focus();
            const submitBtn = document.getElementById('password-submit');
            submitBtn.onclick = () => checkPassword(correctPassword);
            document.getElementById('password-input').onkeyup = (event) => { if (event.key === "Enter") checkPassword(correctPassword); };
        }

        function checkPassword(correctPassword) { if (document.getElementById('password-input').value === correctPassword) { selectLocation(currentSede.charAt(0).toUpperCase() + currentSede.slice(1)); } else { document.getElementById('password-error').classList.remove('hidden'); } }

        async function selectLocation(sede) {
            currentSede = sede.toLowerCase();
            localDataCache[currentSede] = {}; 
            document.getElementById('location-selection').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('location-title').innerText = `Sede di ${sede}`;
            await showPage('corsi'); 
        }

        function goBackToLocationSelection(fromPasswordPrompt = false) { currentSede = ''; document.getElementById('main-app').classList.add('hidden'); hideAllPages(); if(fromPasswordPrompt) { document.getElementById('password-prompt').classList.add('hidden'); document.querySelector('.location-selector').classList.remove('hidden'); } document.getElementById('location-selection').classList.remove('hidden'); }

        async function showPage(pageId) {
            hideAllPages();
            document.getElementById(`page-${pageId}`).classList.remove('hidden');
            if (pageId === 'tesserati') await renderTesserati();
            if (pageId === 'corsi') await renderCorsi();
            if (pageId === 'pagamenti') await renderPagamenti();
            if (pageId === 'lezioni-private') await renderLezioniPrivate();
            if (pageId === 'lezioni-prova') await renderLezioniProva();
        }

        function hideAllPages() { document.querySelectorAll('.page').forEach(page => page.classList.add('hidden')); }
        function toggleForm(formId) { const form = document.getElementById(formId); form.classList.toggle('hidden'); if (form.classList.contains('hidden')) { form.querySelectorAll('input:not([type=radio]):not([type=checkbox]), select').forEach(el => { el.value = ''; }); } }
        async function fetchDataForSede(collectionName) { 
            const path = `sedi/${currentSede}/${collectionName}`;
            if (localDataCache[currentSede] && localDataCache[currentSede][collectionName]) return; 
            try { 
                const snapshot = await db.collection('sedi').doc(currentSede).collection(collectionName).get(); 
                if (!localDataCache[currentSede]) localDataCache[currentSede] = {}; 
                localDataCache[currentSede][collectionName] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); 
            } catch (e) { 
                console.error(`Errore nel caricare ${collectionName}:`, e); 
            } 
        }

        async function aggiungiCorso() {
            const nuovoCorso = { nome: document.getElementById('nome-corso').value.trim(), istruttori: document.getElementById('istruttori-corso').value.trim(), giorni: document.getElementById('giorni-corso').value.trim(), lezioni: [] };
            if (!nuovoCorso.nome || !nuovoCorso.istruttori || !nuovoCorso.giorni) { alert('Tutti i campi sono obbligatori!'); return; }
            try { await db.collection('sedi').doc(currentSede).collection('corsi').add(nuovoCorso); toggleForm('form-nuovo-corso'); localDataCache[currentSede].corsi=null; await renderCorsi(); } catch (e) { console.error("Errore aggiunta corso:", e); alert("Errore nel salvataggio del corso."); }
        }
        async function renderCorsi() {
            const list = document.getElementById('corsi-list'); list.innerHTML = 'Caricamento corsi...';
            try {
                await fetchDataForSede('corsi'); list.innerHTML = '';
                if (!localDataCache[currentSede].corsi || localDataCache[currentSede].corsi.length === 0) { list.innerHTML = '<p>Nessun corso attivo.</p>'; return; }
                for (const corso of localDataCache[currentSede].corsi) {
                    const item = document.createElement('div'); item.className = 'list-item-card';
                    item.innerHTML = `<button type="button" class="collapsible">${corso.nome} <span style="font-weight:400; color: #555;">(${corso.istruttori})</span></button><div class="content"><div class="content-inner"><p><strong>Giorni e Orari:</strong> ${corso.giorni}</p><h4>Registro Lezioni e Presenze</h4><div style="display:flex; gap:10px; align-items:center; margin-bottom: 15px;"><input type="date" id="data-lezione-${corso.id}" style="margin-bottom:0;"><button onclick="aggiungiLezione('${corso.id}')">Aggiungi Lezione</button></div><div id="lezioni-${corso.id}"></div></div></div>`;
                    list.appendChild(item); await renderLezioni(corso.id);
                }
                addCollapsibleEventListeners(); await populateCorsiSelects();
            } catch(e) { console.error("Errore lettura corsi:", e); list.innerHTML = '<p>Errore nel caricamento dei corsi.</p>'; }
        }
        async function aggiungiLezione(corsoId) {
            const dataLezione = document.getElementById(`data-lezione-${corsoId}`).value; if (!dataLezione) { alert('Inserire una data per la lezione!'); return; }
            try { const corsoRef = db.collection('sedi').doc(currentSede).collection('corsi').doc(corsoId); const doc = await corsoRef.get(); const lezioni = doc.data().lezioni || []; if(lezioni.some(l => l.data === dataLezione)) { alert('Lezione già esistente in questa data.'); return; } await corsoRef.update({ lezioni: firebase.firestore.FieldValue.arrayUnion({ data: dataLezione, presenti: [] }) }); localDataCache[currentSede].corsi = null; await renderCorsi(); } catch (e) { console.error("Errore aggiunta lezione:", e); alert("Errore nel salvataggio della lezione."); }
        }
        async function renderLezioni(corsoId) {
            await Promise.all([fetchDataForSede('pagamenti'), fetchDataForSede('tesserati')]);
            const corso = localDataCache[currentSede].corsi.find(c => c.id === corsoId); const container = document.getElementById(`lezioni-${corso.id}`); container.innerHTML = ''; if (!corso.lezioni || corso.lezioni.length === 0) return;
            corso.lezioni.sort((a,b) => new Date(b.data) - new Date(a.data)).forEach(lezione => {
                const iscrittiPaganti = (localDataCache[currentSede].pagamenti || []).filter(p => p.corsoId === corsoId && p.scadenza >= lezione.data).map(p => (localDataCache[currentSede].tesserati || []).find(t => t.id === p.tesseratoId)).filter(t => t);
                let presenzeHtml = '<h5>Tesserati idonei per questa lezione:</h5>';
                if(iscrittiPaganti.length > 0) { iscrittiPaganti.forEach(tesserato => { presenzeHtml += `<p><input type="checkbox" id="presenza-${corso.id}-${lezione.data}-${tesserato.id}" onchange="togglePresenza('${corso.id}', '${lezione.data}', '${tesserato.id}')" ${(lezione.presenti || []).includes(tesserato.id) ? 'checked' : ''}><label for="presenza-${corso.id}-${lezione.data}-${tesserato.id}">${tesserato.nome} ${tesserato.cognome}</label></p>`; }); } else { presenzeHtml += '<p style="font-style:italic; color:#777;">Nessun tesserato con abbonamento valido per questa data.</p>'; }
                container.innerHTML += `<div style="padding:10px; border: 1px solid #eee; border-radius: 5px; margin-bottom:10px;"><strong>Lezione del ${formatDate(lezione.data)}</strong>${presenzeHtml}</div>`;
            });
        }
        async function togglePresenza(corsoId, dataLezione, tesseratoId) {
            try { const corsoRef = db.collection('sedi').doc(currentSede).collection('corsi').doc(corsoId); const doc = await corsoRef.get(); const corso = doc.data(); const lezioni = corso.lezioni || []; const lezioneIndex = lezioni.findIndex(l => l.data === dataLezione); if (lezioneIndex === -1) return; const presenti = lezioni[lezioneIndex].presenti || []; const presenteIndex = presenti.indexOf(tesseratoId); if (presenteIndex > -1) { presenti.splice(presenteIndex, 1); } else { presenti.push(tesseratoId); } lezioni[lezioneIndex].presenti = presenti; await corsoRef.update({ lezioni }); localDataCache[currentSede].corsi.find(c=>c.id===corsoId).lezioni = lezioni; } catch(e) { console.error("Errore presenze:", e); }
        }
        async function aggiungiTesserato() {
            const nuovoTesserato = { nome: document.getElementById('nome-tesserato').value.trim(), cognome: document.getElementById('cognome-tesserato').value.trim(), nascita: document.getElementById('nascita-tesserato').value, luogoNascita: document.getElementById('luogo-nascita-tesserato').value.trim(), genitore: document.getElementById('genitore-tesserato').value.trim(), cf: document.getElementById('cf-tesserato').value.trim(), email: document.getElementById('email-tesserato').value.trim(), telefono: document.getElementById('telefono-tesserato').value.trim(), scadenzaCertificato: document.getElementById('scadenza-certificato').value };
            if (!nuovoTesserato.nome || !nuovoTesserato.cognome || !nuovoTesserato.nascita || !nuovoTesserato.luogoNascita) { alert('Nome, cognome, data e luogo di nascita sono obbligatori!'); return; }
            try { await db.collection('sedi').doc(currentSede).collection('tesserati').add(nuovoTesserato); toggleForm('form-nuovo-tesserato'); localDataCache[currentSede].tesserati=null; await renderTesserati(); } catch(e) { console.error("Errore aggiunta tesserato:", e); alert("Errore nel salvataggio."); }
        }
        async function renderTesserati() {
            const list = document.getElementById('tesserati-list'); list.innerHTML = 'Caricamento tesserati...';
            try {
                await fetchDataForSede('tesserati'); list.innerHTML = '';
                if (!localDataCache[currentSede].tesserati || localDataCache[currentSede].tesserati.length === 0) { list.innerHTML = '<p>Nessun tesserato trovato.</p>'; await populateTesseratiSelects(); return; }
                localDataCache[currentSede].tesserati.sort((a,b)=>a.cognome.localeCompare(b.cognome)).forEach(tesserato => {
                    const item = document.createElement('div'); item.className = 'list-item-card';
                    item.innerHTML = `<button type="button" class="collapsible">${tesserato.cognome} ${tesserato.nome}</button><div class="content"><div class="content-inner"><p><strong>Data di Nascita:</strong> ${formatDate(tesserato.nascita)}</p><p><strong>Luogo di Nascita:</strong> ${tesserato.luogoNascita}</p>${tesserato.genitore ? `<p><strong>Genitore:</strong> ${tesserato.genitore}</p>` : ''}${tesserato.cf ? `<p><strong>Codice Fiscale:</strong> ${tesserato.cf}</p>` : ''}${tesserato.email ? `<p><strong>Email:</strong> ${tesserato.email}</p>` : ''}${tesserato.telefono ? `<p><strong>Telefono:</strong> ${tesserato.telefono}</p>` : ''}${tesserato.scadenzaCertificato ? `<p><strong>Scadenza Certificato Medico:</strong> ${formatDate(tesserato.scadenzaCertificato)}</p>` : ''}</div></div>`;
                    list.appendChild(item);
                });
                addCollapsibleEventListeners(); await populateTesseratiSelects();
            } catch(e) { console.error("Errore lettura tesserati:", e); list.innerHTML = '<p>Errore nel caricamento dei tesserati.</p>'; }
        }
        async function aggiungiPagamento() {
            const nuovoPagamento = { tesseratoId: document.getElementById('tesserato-pagamento').value, importo: document.getElementById('importo-pagamento').value, metodo: document.getElementById('metodo-pagamento').value, corsoId: document.getElementById('corso-pagamento').value, scadenza: document.getElementById('scadenza-abbonamento').value };
            if(!nuovoPagamento.tesseratoId || !nuovoPagamento.importo || !nuovoPagamento.corsoId || !nuovoPagamento.scadenza) { alert("Compilare tutti i campi del pagamento!"); return; }
            try { await db.collection('sedi').doc(currentSede).collection('pagamenti').add(nuovoPagamento); toggleForm('form-nuovo-pagamento'); localDataCache[currentSede].pagamenti=null; await renderPagamenti(); } catch(e) { console.error("Errore aggiunta pagamento:", e); alert("Errore nel salvataggio."); }
        }
        async function renderPagamenti() {
            const list = document.getElementById('pagamenti-list'); list.innerHTML = 'Caricamento pagamenti...';
            await Promise.all([fetchDataForSede('tesserati'), fetchDataForSede('corsi'), fetchDataForSede('pagamenti')]);
            list.innerHTML = ''; if (!localDataCache[currentSede].pagamenti || localDataCache[currentSede].pagamenti.length === 0) { list.innerHTML = '<p>Nessun pagamento registrato.</p>'; return; }
            const oggi = new Date().toISOString().split('T')[0];
            localDataCache[currentSede].pagamenti.forEach(p => {
                const tesserato = (localDataCache[currentSede].tesserati || []).find(t => t.id === p.tesseratoId); const corso = (localDataCache[currentSede].corsi || []).find(c => c.id === p.corsoId); if (!tesserato || !corso) return;
                const alertHtml = p.scadenza < oggi ? `<div class="renewal-alert"><p>Abbonamento scaduto il ${formatDate(p.scadenza)}.</p><button onclick="rinnovaAbbonamento('${p.tesseratoId}', '${p.corsoId}')">Rinnova</button><button class="secondary-button" onclick="this.parentElement.style.display='none'">OK</button></div>` : '';
                const item = document.createElement('div'); item.className = 'list-item-card';
                item.innerHTML = `<button type="button" class="collapsible">${tesserato.cognome} ${tesserato.nome} - Corso: ${corso.nome}</button><div class="content"><div class="content-inner">${alertHtml}<p><strong>Importo:</strong> ${p.importo} €</p><p><strong>Metodo:</strong> ${p.metodo}</p><p><strong>Scadenza:</strong> ${formatDate(p.scadenza)}</p></div></div>`;
                list.appendChild(item);
            });
            addCollapsibleEventListeners();
        }
        function rinnovaAbbonamento(tesseratoId, corsoId) { const tesserato = localDataCache[currentSede].tesserati.find(t=> t.id === tesseratoId); if(!document.getElementById('form-nuovo-pagamento').classList.contains('hidden')){ toggleForm('form-nuovo-pagamento');} toggleForm('form-nuovo-pagamento'); document.getElementById('tesserato-pagamento').value = tesseratoId; document.getElementById('corso-pagamento').value = corsoId; alert(`Pre-compilato form per rinnovo di ${tesserato.nome} ${tesserato.cognome}.`); }
        async function aggiungiVenditaPrivata() {
            const vendita = { tesseratoId: document.getElementById('tesserato-lezione-privata').value, istruttore: document.getElementById('istruttore-lezione-privata').value.trim(), prodotto: document.getElementById('prodotto-lezione-privata').value, costo: document.getElementById('costo-lezione-privata').value, metodo: document.getElementById('metodo-pagamento-privata').value, date: [] };
            if(!vendita.tesseratoId || !vendita.costo || !vendita.istruttore) { alert("Tesserato, istruttore e costo sono obbligatori!"); return; }
            if(vendita.prodotto === 'singola') { const data = document.getElementById('data-lezione-singola').value; if(!data) { alert("Data obbligatoria!"); return; } vendita.date.push(data); } else { document.querySelectorAll('.data-pacchetto-input').forEach(i => { if(i.value) vendita.date.push(i.value); }); }
            try { await db.collection('sedi').doc(currentSede).collection('lezioniPrivate').add(vendita); toggleForm('form-lezione-privata'); localDataCache[currentSede].lezioniPrivate=null; await renderLezioniPrivate(); } catch(e) { console.error("Errore aggiunta vendita:", e); alert("Errore nel salvataggio."); }
        }
        async function renderLezioniPrivate() {
            const list = document.getElementById('lezioni-private-list'); list.innerHTML = 'Caricamento lezioni...';
            await Promise.all([fetchDataForSede('tesserati'), fetchDataForSede('lezioniPrivate')]);
            await populateFiltroIstruttori(); list.innerHTML = '';
            const filtroIstruttore = document.getElementById('filtro-istruttore-privata').value;
            let lezioni = localDataCache[currentSede].lezioniPrivate || [];
            if (filtroIstruttore !== 'all') { lezioni = lezioni.filter(l => l.istruttore === filtroIstruttore); }
            if (lezioni.length === 0) { list.innerHTML = '<p>Nessuna lezione privata trovata.</p>'; return; }
            lezioni.forEach(vendita => {
                const tesserato = localDataCache[currentSede].tesserati.find(t => t.id === vendita.tesseratoId); if (!tesserato) return;
                const item = document.createElement('div'); item.className = 'list-item-card';
                item.innerHTML = `<button type="button" class="collapsible">${tesserato.cognome} ${tesserato.nome} - ${vendita.prodotto === 'singola' ? 'Lezione Singola' : 'Pacchetto'}</button><div class="content"><div class="content-inner"><p><strong>Istruttore:</strong> ${vendita.istruttore}</p><p><strong>Costo:</strong> ${vendita.costo} €</p><p><strong>Metodo:</strong> ${vendita.metodo}</p><p><strong>Date:</strong></p><ul>${(vendita.date || []).map(d => `<li>${formatDate(d)}</li>`).join('') || 'Nessuna data.'}</ul></div></div>`;
                list.appendChild(item);
            }); addCollapsibleEventListeners();
        }
        async function aggiungiLezioneProva() {
            const corso = (localDataCache[currentSede].corsi || []).find(c => c.id === document.getElementById('corso-provato').value);
            const prova = { nome: document.getElementById('nome-prova').value.trim(), cognome: document.getElementById('cognome-prova').value.trim(), dataProva: document.getElementById('data-prova').value, genitore: document.getElementById('genitore-prova').value.trim(), corsoProvatoId: corso ? corso.id : '', corsoProvatoNome: corso ? corso.nome : 'N/D', email: document.getElementById('email-prova').value.trim(), telefono: document.getElementById('telefono-prova').value.trim() };
            if(!prova.nome || !prova.cognome || !prova.corsoProvatoId || !prova.dataProva) { alert("Nome, cognome, corso e data sono obbligatori!"); return; }
            try { await db.collection('sedi').doc(currentSede).collection('lezioniProva').add(prova); toggleForm('form-lezione-prova'); localDataCache[currentSede].lezioniProva=null; await renderLezioniProva(); } catch(e) { console.error("Errore aggiunta prova:", e); alert("Errore nel salvataggio."); }
        }
        async function renderLezioniProva() {
            const list = document.getElementById('lezioni-prova-list'); list.innerHTML = 'Caricamento prove...';
            await Promise.all([fetchDataForSede('lezioniProva')]);
            await populateFiltroCorsiProva(); list.innerHTML = '';
            const filtroCorsoId = document.getElementById('filtro-corso-prova').value;
            let prove = localDataCache[currentSede].lezioniProva || [];
            if (filtroCorsoId !== 'all') { prove = prove.filter(p => p.corsoProvatoId == filtroCorsoId); }
            if (prove.length === 0) { list.innerHTML = '<p>Nessuna lezione di prova trovata.</p>'; return; }
            prove.sort((a,b) => a.cognome.localeCompare(b.cognome)).forEach(prova => {
                const item = document.createElement('div'); item.className = 'list-item-card';
                item.innerHTML = `<button type="button" class="collapsible">${prova.cognome} ${prova.nome} - Prova per: ${prova.corsoProvatoNome}</button><div class="content"><div class="content-inner"><p><strong>Data Prova:</strong> ${formatDate(prova.dataProva)}</p>${prova.genitore ? `<p><strong>Genitore:</strong> ${prova.genitore}</p>` : ''}${prova.email ? `<p><strong>Email:</strong> ${prova.email}</p>` : ''}${prova.telefono ? `<p><strong>Telefono:</strong> ${prova.telefono}</p>` : ''}</div></div>`;
                list.appendChild(item);
            }); addCollapsibleEventListeners();
        }

        async function populateTesseratiSelects() { await fetchDataForSede('tesserati'); const tesserati = (localDataCache[currentSede].tesserati || []).sort((a,b)=>a.cognome.localeCompare(b.cognome)); const options = '<option value="">Seleziona Tesserato</option>' + tesserati.map(t => `<option value="${t.id}">${t.cognome} ${t.nome}</option>`).join(''); document.getElementById('tesserato-pagamento').innerHTML = options; document.getElementById('tesserato-lezione-privata').innerHTML = options; }
        async function populateCorsiSelects() { await fetchDataForSede('corsi'); const corsi = localDataCache[currentSede].corsi || []; const options = '<option value="">Seleziona Corso</option>' + corsi.map(c => `<option value="${c.id}">${c.nome}</option>`).join(''); document.getElementById('corso-pagamento').innerHTML = options; document.getElementById('corso-provato').innerHTML = options; }
        async function populateFiltroIstruttori() { await fetchDataForSede('lezioniPrivate'); const select = document.getElementById('filtro-istruttore-privata'); const istruttori = [...new Set((localDataCache[currentSede].lezioniPrivate || []).map(i => i.istruttore))]; select.innerHTML = '<option value="all">Filtra per istruttore (Tutti)</option>' + istruttori.sort().map(i => `<option value="${i}">${i}</option>`).join(''); }
        async function populateFiltroCorsiProva() { await fetchDataForSede('lezioniProva'); const select = document.getElementById('filtro-corso-prova'); const corsi = [...new Map((localDataCache[currentSede].lezioniProva || []).map(i => [i.corsoProvatoId, i])).values()]; select.innerHTML = '<option value="all">Filtra per corso (Tutti)</option>' + corsi.filter(c=>c.corsoProvatoId).map(c => `<option value="${c.corsoProvatoId}">${c.corsoProvatoNome}</option>`).join(''); }
        
        function addDateInput() { const c=document.getElementById('date-inputs'); if(c.children.length<10){c.insertAdjacentHTML('beforeend','<input type="date" class="data-pacchetto-input">');}else{alert("Massimo 10 date.");} }
        function togglePacchettoDate(value) { document.getElementById('data-lezione-singola-container').classList.toggle('hidden', value === 'pacchetto'); document.getElementById('date-pacchetto').classList.toggle('hidden', value === 'singola'); }
        function addCollapsibleEventListeners() { document.querySelectorAll(".collapsible").forEach(c => { c.removeEventListener("click", expandContent); c.addEventListener("click", expandContent); }); }
        function expandContent() { this.classList.toggle("active"); const c = this.nextElementSibling; if (c.style.maxHeight) { c.style.maxHeight = null; } else { c.style.maxHeight = c.scrollHeight + "px"; } }
        function searchList(inputId, listId) { const filter = document.getElementById(inputId).value.toUpperCase(); document.getElementById(listId).querySelectorAll('.list-item-card').forEach(item => { item.style.display = item.textContent.toUpperCase().indexOf(filter) > -1 ? "" : "none"; }); }
        function downloadExcel() { alert('Funzionalità di download non ancora implementata per dati da Firestore.'); }
    </script>
</body>
</html>
